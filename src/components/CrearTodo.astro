---
import { db, Category, Todo } from 'astro:db'

if (Astro.request.method === 'POST') {
  // Crear Todo
  const formData = await Astro.request.formData()
  const titulo = formData.get('titulo')
  const descripcion = formData.get('descripcion')
  const categoria = formData.get('categoria')

  console.log({ titulo, descripcion, categoria })

  if (!titulo || !descripcion || !categoria) {
    return new Response('Faltan datos', { status: 400 })
  }

  if (
    typeof titulo === 'string' &&
    typeof descripcion === 'string' &&
    typeof categoria === 'string' &&
    titulo.length > 0 &&
    descripcion.length > 0
  ) {
    await db.insert(Todo).values({
      title: titulo,
      description: descripcion,
      category_id: categoria,
      user_id: '333'
    })
  } else {
    console.log('Datos incorrectos')
  }
}

const categories = await db.select().from(Category)
---

<form method='post'>
  <label for='titulo'>Título:</label>
  <input
    type='text'
    id='titulo'
    name='titulo'
    required
  />

  <label for='descripcion'>Descripción:</label>
  <textarea
    id='descripcion'
    name='descripcion'
    required
  >
  </textarea>

  <label for='categoria'>Categoría:</label>
  <select
    id='categoria'
    name='categoria'
    required
  >
    {
      categories.map((category) => (
        <option value={category.id}>{category.label}</option>
      ))
    }
  </select>

  <button type='submit'>Enviar</button>
</form>

<style>
  form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding-bottom: 2em;
    max-width: 400px;
    margin: 0 auto;
  }

  form > * {
    font-size: 1rem;
  }

  label {
    font-weight: bold;
  }

  input,
  textarea,
  select {
    padding: 0.5rem;
    border-radius: 0.25rem;
  }

  button {
    margin-top: 1em;
    border: none;
    outline: none;
    padding: 0.75rem;
    border-radius: 0.5rem;
    background-color: hsl(120, 50%, 30%);
    color: white;
  }

  button:focus {
    outline: none;
  }

  input:focus,
  textarea:focus,
  select:focus {
    outline: none;
    border-color: #000;
  }
</style>
